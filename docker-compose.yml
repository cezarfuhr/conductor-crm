services:
  # ==========================================
  # CORE OPENSOURCE SERVICES
  # MongoDB is shared with conductor-community (localhost:27017)
  # Different ports to avoid conflicts when running both projects
  # ==========================================

  conductor-api:
    image: primoia/conductor:latest
    container_name: conductor-crm-api
    restart: unless-stopped
    env_file:
      - ./config/conductor/.env
    environment:
      - CONDUCTOR_PLUGIN_PATH=/plugins
    volumes:
      - ./config/conductor/config.yaml:/app/config.yaml:ro
      - ./plugins:/plugins:ro
    ports:
      - "3001:8000"  # Different port to avoid conflict with community
    networks:
      - conductor-crm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host MongoDB

  gateway:
    image: primoia/conductor-gateway:latest
    container_name: conductor-crm-gateway
    restart: unless-stopped
    depends_on:
      - conductor-api
    env_file:
      - ./config/gateway/.env
    volumes:
      - ./config/gateway/config.yaml:/app/config.yaml:ro
    ports:
      - "5008:8080"  # Different port to avoid conflict with community
    networks:
      - conductor-crm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host MongoDB

  web:
    image: primoia/conductor-web:latest
    container_name: conductor-crm-web
    restart: unless-stopped
    depends_on:
      - gateway
    ports:
      - "8081:80"  # Different port to avoid conflict with community
    networks:
      - conductor-crm-network

  # ==========================================
  # CRM PRIVATE SERVICES
  # ==========================================

  crm-backend:
    build: ./src/backend
    container_name: conductor-crm-backend
    restart: unless-stopped
    depends_on:
      - gateway
    env_file:
      - ./config/crm/.env
    environment:
      - NODE_ENV=production
      - CONDUCTOR_GATEWAY_URL=http://gateway:8080
      - MONGODB_URI=mongodb://admin:conductor123@host.docker.internal:27017/crm?authSource=admin
    ports:
      - "5007:5007"
    networks:
      - conductor-crm-network
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Access host MongoDB

  crm-frontend:
    build: ./src/frontend
    container_name: conductor-crm-frontend
    restart: unless-stopped
    depends_on:
      - crm-backend
    environment:
      - API_URL=http://crm-backend:5007
      - CONDUCTOR_WEB_URL=http://web:80
    ports:
      - "4200:80"
    networks:
      - conductor-crm-network

networks:
  conductor-crm-network:
    driver: bridge
